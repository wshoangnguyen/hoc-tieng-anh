<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Đăng nhập</title>
</head>
    <!-- Logo lắc lư và phản hồi khi di chuột -->
    <div class="fixed bottom-4 right-4 z-50 cursor-pointer group"
         onclick="window.location.href='https://hoctienganhdelam.com/'">
        <img src="logo.png" alt="Logo" 
             class="h-16
                    transition-all duration-300
                    animate-[gentleWave_5s_ease-in-out_infinite]
                    group-hover:scale-125 group-hover:rotate-12">
        <!-- Tooltip nhỏ khi hover -->
        <span class="absolute bottom-full right-0 mb-2 px-3 py-1 bg-gray-800 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
            Về trang chủ!
        </span>
    </div>

    <style>
        @keyframes gentleWave {
  0%, 100% {
    transform: translateX(0) rotate(0deg);
  }
  15%, 45%, 75% {
    transform: translateX(-5px) rotate(-3deg);
  }
  30%, 60%, 90% {
    transform: translateX(5px) rotate(3deg);
  }
        }
        .animate-gentle-wave {
            animation: gentleWave 5s ease-in-out infinite;
        }
    </style>
<body class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-b from-white to-[#ffefd3]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
        <!-- Tiêu đề -->
        <div class="text-center mb-8">
            <img src="banner.jpg" alt="Học tiếng Anh dễ lắm" class="max-w-full h-auto rounded-lg mx-auto">
        </div>     
        
        <!-- Form nhập liệu -->
        <div class="space-y-4">
            <!-- Tên đăng nhập -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tên đăng nhập</label>
                <input 
                    type="text" 
                    id="username" 
                    placeholder="VD: nguyen.minh.hoang"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition"
                />
                <p class="text-xs text-gray-400 mt-1">Tên không dấu, cách nhau bằng dấu chấm</p>
            </div>
            
            <!-- Tên hiển thị (chỉ hiện khi đăng ký) -->
            <div id="displayNameField">
                <label class="block text-sm font-medium text-gray-700 mb-1">Tên hiển thị</label>
                <input 
                    type="text" 
                    id="displayName" 
                    placeholder="VD: Nguyễn Minh Hoàng"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition"
                />
                <p class="text-xs text-gray-400 mt-1">Tên tiếng Việt có dấu sẽ hiển thị trong dashboard</p>
            </div>
            
            <!-- Mật khẩu -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
                <input 
                    type="password" 
                    id="password" 
                    placeholder="••••••"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition"
                />
                <p class="text-xs text-gray-400 mt-1">Ít nhất 6 ký tự</p>
            </div>

        <!-- Khu vực thông báo -->
        <div id="message" class="mt-6 p-4 rounded-xl hidden"></div>
 

            <!-- Các nút -->
            <div class="pt-4">
                <button 
                    onclick="handleSignIn()"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-xl transition duration-200 transform hover:scale-[1.02]"
                    id="signInButton">
                    Đăng nhập
                </button>
                <button 
                    onclick="handleSignUp()"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-xl transition duration-200 transform hover:scale-[1.02] hidden"
                    id="signUpButton">
                    Đăng ký
                </button>
            </div>
        </div>

            <!-- Tabs chuyển đổi Đăng nhập/Đăng ký -->
            <div class="grid gap-2 p-1 bg-white-100 rounded-lg">
                <button onclick="switchToSignIn()" 
                        class="flex-1 py-2 text-sm font-medium rounded-lg transition-all duration-200"
                        id="signInTab">
                    
                </button>
                <button onclick="switchToSignUp()" 
                        class="flex-1 py-2 text-sm font-medium rounded-lg transition-all duration-200"
                        id="signUpTab">
                    
                </button>
            </div>
   </div>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { 
    getFirestore, 
    doc,           // Tạo reference đến một document
    setDoc,        // Tạo hoặc ghi đè document
    addDoc,        // Thêm document với ID tự động
    collection,    // Tạo reference đến một collection
    getDoc,        // Lấy 1 document
    getDocs,       // Lấy nhiều documents
    query,         // Tạo query
    where,         // Điều kiện lọc
    updateDoc,     // Cập nhật document
    deleteDoc,     // Xóa document
    serverTimestamp // Lấy thời gian từ server (tránh lệch múi giờ client)
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyBqm6-fzVVqA5DUYZ6Ke_fX9N6ON5pBzVE",
            authDomain: "quanly-hocvien.firebaseapp.com",
            projectId: "quanly-hocvien",
            storageBucket: "quanly-hocvien.firebasestorage.app",
            messagingSenderId: "1095021882397",
            appId: "1:1095021882397:web:68038ec5ac0e593ca02af4"
        };
// Khởi tạo Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app); // Kết nối đến Firestore

// Export để các hàm khác có thể sử dụng
export { auth, db };
        // Hàm hiển thị thông báo
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'mt-6 p-4 rounded-xl text-center font-medium ';
            
            if (type === 'success') {
                messageDiv.className += 'bg-green-100 text-green-700 border border-green-200';
            } else if (type === 'error') {
                messageDiv.className += 'bg-red-100 text-red-700 border border-red-200';
            } else {
                messageDiv.className += 'bg-blue-100 text-blue-700 border border-blue-200';
            }
            
            messageDiv.style.display = 'block';
        }

        function createVirtualEmail(username) {
            const cleanUsername = username.toLowerCase().trim();
            return `${cleanUsername}@hocvien.local`;
        }

        // Chuyển đổi giữa đăng nhập và đăng ký
        window.switchToSignIn = function() {
            document.getElementById('signInTab').classList.add('bg-white', 'shadow');
            document.getElementById('signUpTab').classList.remove('bg-white', 'shadow');
            document.getElementById('displayNameField').classList.add('hidden');
            document.getElementById('signInButton').classList.remove('hidden');
            document.getElementById('signUpButton').classList.add('hidden');
        };

        window.switchToSignUp = function() {
            document.getElementById('signUpTab').classList.add('bg-white', 'shadow');
            document.getElementById('signInTab').classList.remove('bg-white', 'shadow');
            document.getElementById('displayNameField').classList.remove('hidden');
            document.getElementById('signUpButton').classList.remove('hidden');
            document.getElementById('signInButton').classList.add('hidden');
        };

        // Mặc định hiển thị form đăng nhập
        switchToSignIn();

        window.handleSignUp = async function() {
            const username = document.getElementById('username').value.trim();
            const displayName = document.getElementById('displayName').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !displayName || !password) {
                showMessage('Vui lòng nhập đầy đủ thông tin!', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('Mật khẩu phải có ít nhất 6 ký tự', 'error');
                return;
            }

    try {
        // Bước 1: Tạo tài khoản Firebase Authentication
        const virtualEmail = createVirtualEmail(username);
        const userCredential = await createUserWithEmailAndPassword(auth, virtualEmail, password);
        const user = userCredential.user; // Lấy thông tin user từ Firebase Auth
        
        // Bước 2: Tạo document trong collection 'users' với type = "parent"
        // Sử dụng setDoc với ID là user.uid để đồng bộ với Auth
        await setDoc(doc(db, "users", user.uid), {
            username: username,           // Tên đăng nhập (không dấu)
            displayName: displayName,     // Tên hiển thị (có dấu)
            email: virtualEmail,          // Email ảo
            type: "parent",               // Mặc định là phụ huynh
            createdAt: serverTimestamp(), // Thời gian tạo từ server
            createdBy: user.uid,           // Tự tạo
            isActive: true,                // Trạng thái hoạt động
            lastLoginAt: serverTimestamp() // Lần đăng nhập cuối
        });


        // Bước 3: Lưu thông tin vào localStorage
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userDisplayName', displayName);
        localStorage.setItem('userType', 'parent'); // Lưu type để phân quyền
        
        showMessage('Đăng ký thành công! Đang chuyển trang...', 'success');
        
        setTimeout(() => {
            window.location.href = 'dashboard.html';
        }, 1000);

    } catch (error) {
        console.error('Lỗi đăng ký:', error);
        
        // Xử lý các lỗi thường gặp
        switch (error.code) {
            case 'auth/email-already-in-use':
                showMessage('Tên đăng nhập này đã được sử dụng!', 'error');
                break;
            case 'auth/weak-password':
                showMessage('Mật khẩu quá yếu!', 'error');
                break;
            case 'permission-denied':
                showMessage('Không có quyền thực hiện thao tác này!', 'error');
                break;
            default:
                showMessage('Có lỗi xảy ra: ' + error.message, 'error');
        }
    }
};

        window.handleSignIn = async function() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showMessage('Vui lòng nhập tên đăng nhập và mật khẩu!', 'error');
                return;
            }

            try {
                const virtualEmail = createVirtualEmail(username);
                const userCredential = await signInWithEmailAndPassword(auth, virtualEmail, password);
                const user = userCredential.user;

                const userDoc = await getDoc(doc(db, "users", user.uid));
                const userData = userDoc.data();
                
                // Lưu tên hiển thị vào localStorage
                const displayName = userData?.displayName || username;
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userDisplayName', displayName);

                showMessage(`Đăng nhập thành công! Chào ${displayName}`, 'success');
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);

            } catch (error) {
                console.error('Lỗi đăng nhập:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showMessage('Tên đăng nhập hoặc mật khẩu không đúng!', 'error');
                } else {
                    showMessage('Có lỗi xảy ra: ' + error.message, 'error');
                }
            }
        };
    </script>
</body>
</html>