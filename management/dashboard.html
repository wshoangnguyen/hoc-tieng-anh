<!-- file: dashboard.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Dashboard - H·ªçc ti·∫øng Anh</title>
    <style>
        @keyframes gentleWave {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            15%, 45%, 75% { transform: translateX(-5px) rotate(-3deg); }
            30%, 60%, 90% { transform: translateX(5px) rotate(3deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .sidebar-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .menu-item {
            transition: all 0.2s ease;
        }
        
        .menu-item:hover {
            transform: translateX(5px);
        }
        
        .menu-item.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
        }

        .admin-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-[#ffefd3]">
    <!-- Logo l·∫Øc l∆∞ -->
    <div class="fixed bottom-4 right-4 z-50 cursor-pointer group"
         onclick="window.location.href='https://hoctienganhdelam.com/'">
        <img src="logo.png" alt="Logo" 
             class="h-16 transition-all duration-300 animate-[gentleWave_3s_ease-in-out_infinite] group-hover:scale-125 group-hover:rotate-12">
        <span class="absolute bottom-full right-0 mb-2 px-3 py-1 bg-gray-800 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
            V·ªÅ trang ch·ªß!
        </span>
    </div>

    <!-- Container ch√≠nh v·ªõi sidebar -->
    <div class="flex min-h-screen">
        <!-- Sidebar - Menu b√™n tr√°i -->
        <aside class="fixed lg:static w-64 lg:w-72 h-screen lg:h-auto bg-white shadow-2xl lg:shadow-lg sidebar-transition z-40
                      transform -translate-x-full lg:translate-x-0"
               id="sidebar">
            <div class="p-6 h-full flex flex-col">
                <!-- Logo -->
                <div class="mb-8">
                    <img src="banner.jpg" alt="H·ªçc ti·∫øng Anh d·ªÖ l·∫Øm" class="w-full h-auto rounded-lg">
                </div>

                <!-- Menu items -->
                <nav class="space-y-2 flex-1">
                    <a href="#" onclick="setActiveMenu(this, 'home')" 
                       class="menu-item active flex items-center space-x-3 p-3 rounded-xl text-gray-700 hover:bg-blue-50 sidebar-transition">
                        <i class="fas fa-home w-6"></i>
                        <span class="font-medium">Trang ch·ªß</span>
                    </a>
                    
                    <a href="#" onclick="setActiveMenu(this, 'students')" 
                       class="menu-item flex items-center space-x-3 p-3 rounded-xl text-gray-700 hover:bg-blue-50 sidebar-transition">
                        <i class="fas fa-users w-6"></i>
                        <span class="font-medium">H·ªçc sinh</span>
                    </a>
                    
                    <a href="#" onclick="setActiveMenu(this, 'assessments')" 
                       class="menu-item flex items-center space-x-3 p-3 rounded-xl text-gray-700 hover:bg-blue-50 sidebar-transition">
                        <i class="fas fa-star w-6"></i>
                        <span class="font-medium">ƒê√°nh gi√°</span>
                    </a>
                    
                    <a href="#" onclick="setActiveMenu(this, 'payments')" 
                       class="menu-item flex items-center space-x-3 p-3 rounded-xl text-gray-700 hover:bg-blue-50 sidebar-transition">
                        <i class="fas fa-money-bill-wave w-6"></i>
                        <span class="font-medium">H·ªçc ph√≠</span>
                    </a>

                    <a href="#" onclick="setActiveMenu(this, 'rewards')" 
                       class="menu-item flex items-center space-x-3 p-3 rounded-xl text-gray-700 hover:bg-blue-50 sidebar-transition">
                        <i class="fas fa-gift w-6"></i>
                        <span class="font-medium">ƒêi·ªÉm th∆∞·ªüng</span>
                    </a>

                    <!-- Menu admin ch·ªâ hi·ªán v·ªõi user type = admin -->
                    <div id="adminMenuSection" class="hidden">
                        <div class="border-t border-gray-200 my-4"></div>
                        <a href="#" onclick="setActiveMenu(this, 'users')" 
                           class="menu-item flex items-center space-x-3 p-3 rounded-xl text-gray-700 hover:bg-blue-50 sidebar-transition">
                            <i class="fas fa-user-cog w-6"></i>
                            <span class="font-medium">Qu·∫£n l√Ω User</span>
                        </a>
                    </div>
                </nav>

                <!-- User info trong sidebar -->
                <div class="mt-auto pt-6">
                    <div class="p-4 bg-gray-50 rounded-xl" id="sidebarUserInfo">
                        <!-- S·∫Ω ƒë∆∞·ª£c load b·∫±ng JS -->
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-blue-500"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-gray-800 truncate">ƒêang t·∫£i...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- N√∫t toggle menu cho mobile -->
        <button onclick="toggleSidebar()" 
                class="lg:hidden fixed top-4 left-4 z-50 bg-white p-2 rounded-lg shadow-lg hover:bg-gray-50 transition">
            <i class="fas fa-bars text-gray-600 text-xl"></i>
        </button>

        <!-- Overlay cho mobile -->
        <div onclick="toggleSidebar()" 
             class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-30 hidden transition-opacity"
             id="overlay"></div>

        <!-- N·ªôi dung ch√≠nh -->
        <main class="flex-1 p-4 lg:p-8 ml-0 lg:ml-0 pt-16 lg:pt-8">
            <div class="max-w-6xl mx-auto">
                <!-- Header v·ªõi th√¥ng tin user -->
                <div class="bg-white rounded-2xl shadow-lg p-4 lg:p-6 mb-6 fade-in">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-800" id="greeting">Xin ch√†o! üëã</h1>
                            <p class="text-gray-600 mt-1" id="welcomeMessage">Ch√†o m·ª´ng b·∫°n quay tr·ªü l·∫°i</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium" id="userTypeBadge">ƒêang t·∫£i...</span>
                            <button onclick="logout()"
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 lg:px-6 py-2 rounded-xl transition duration-200 flex items-center gap-2">
                                <i class="fas fa-sign-out-alt"></i>
                                <span class="hidden lg:inline">ƒêƒÉng xu·∫•t</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- N·ªôi dung ch√≠nh thay ƒë·ªïi theo menu -->
                <div id="mainContent" class="fade-in">
                    <!-- Trang ch·ªß content -->
                    <div id="homeContent" class="space-y-6">
                        <div class="bg-white rounded-2xl shadow-lg p-6 lg:p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng! üéâ</h2>
                            <p class="text-gray-600 leading-relaxed">
                                ƒê√¢y l√† h·ªá th·ªëng qu·∫£n l√Ω h·ªçc vi√™n d√†nh cho c√°c l·ªõp ti·∫øng Anh Online. 
                                B·∫°n c√≥ th·ªÉ qu·∫£n l√Ω h·ªçc sinh, theo d√µi ƒë√°nh gi√° v√† h·ªçc ph√≠ t·∫°i ƒë√¢y.
                            </p>
                        </div>

                        <!-- Th·ªëng k√™ nhanh -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="statistics">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white">
                                <i class="fas fa-users text-3xl mb-3"></i>
                                <h3 class="text-lg font-medium opacity-90">T·ªïng h·ªçc sinh</h3>
                                <p class="text-3xl font-bold">0</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white">
                                <i class="fas fa-star text-3xl mb-3"></i>
                                <h3 class="text-lg font-medium opacity-90">ƒê√°nh gi√° trung b√¨nh</h3>
                                <p class="text-3xl font-bold">-</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white">
                                <i class="fas fa-money-bill-wave text-3xl mb-3"></i>
                                <h3 class="text-lg font-medium opacity-90">H·ªçc ph√≠ th√°ng n√†y</h3>
                                <p class="text-3xl font-bold">0ƒë</p>
                            </div>
                        </div>
                    </div>

                    <!-- Qu·∫£n l√Ω h·ªçc sinh -->
                    <div id="studentsContent" class="hidden">
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">üìö Qu·∫£n l√Ω H·ªçc sinh</h2>
                                <button onclick="showAddStudentModal()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl flex items-center gap-2">
                                    <i class="fas fa-plus"></i>
                                    <span>Th√™m h·ªçc sinh</span>
                                </button>
                            </div>
                            <div id="studentsList" class="space-y-4">
                                <!-- Danh s√°ch h·ªçc sinh s·∫Ω load b·∫±ng JS -->
                                <p class="text-gray-500 text-center py-8">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Qu·∫£n l√Ω User (ch·ªâ admin) -->
                    <div id="usersContent" class="hidden">
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">üë• Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h2>
                            <div id="usersList" class="space-y-4">
                                <!-- Danh s√°ch users s·∫Ω load b·∫±ng JS -->
                                <p class="text-gray-500 text-center py-8">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                            </div>
                        </div>
                    </div>

                    <!-- C√°c content kh√°c -->
                    <div id="assessmentsContent" class="hidden">
                        <div class="bg-white rounded-2xl shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">ƒê√°nh gi√° h·ªçc sinh ‚≠ê</h2>
                            <p class="text-gray-500">T√≠nh nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn...</p>
                        </div>
                    </div>

                    <div id="paymentsContent" class="hidden">
                        <div class="bg-white rounded-2xl shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Qu·∫£n l√Ω H·ªçc ph√≠ üí∞</h2>
                            <p class="text-gray-500">T√≠nh nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn...</p>
                        </div>
                    </div>

                    <div id="rewardsContent" class="hidden">
                        <div class="bg-white rounded-2xl shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">ƒêi·ªÉm th∆∞·ªüng üéÅ</h2>
                            <p class="text-gray-500">T√≠nh nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ========== MODALS ========== -->
    <!-- Modal th√™m h·ªçc sinh -->
    <div id="addStudentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Th√™m h·ªçc sinh m·ªõi</h3>
            <form id="addStudentForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n <span class="text-red-500">*</span></label>
                    <input type="text" id="studentFullName" required
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√™n ti·∫øng Anh (bi·ªát danh)</label>
                    <input type="text" id="studentNickname"
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y sinh</label>
                    <input type="date" id="studentDob"
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">S·ªë ƒëi·ªán tho·∫°i ph·ª• huynh</label>
                    <input type="tel" id="studentPhone"
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">L·ªõp</label>
                    <select id="studentClass" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                        <option value="">Ch·ªçn l·ªõp</option>
                        <option value="Family & Friends 1">Family & Friends 1</option>
                        <option value="Family & Friends 2">Family & Friends 2</option>
                        <option value="Family & Friends 3">Family & Friends 3</option>
                        <option value="Flyers">Flyers</option>
                        <option value="Movers">Movers</option>
                        <option value="Starters">Starters</option>
                    </select>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit"
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl">
                        Th√™m
                    </button>
                    <button type="button" onclick="hideAddStudentModal()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-xl">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal s·ª≠a h·ªçc sinh -->
    <div id="editStudentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è Ch·ªânh s·ª≠a H·ªçc sinh</h3>
                <button onclick="hideEditStudentModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="editStudentForm" class="space-y-4">
                <input type="hidden" id="editStudentId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n <span class="text-red-500">*</span></label>
                    <input type="text" id="editStudentFullName" required
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√™n ti·∫øng Anh (bi·ªát danh)</label>
                    <input type="text" id="editStudentNickname"
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y sinh</label>
                    <input type="date" id="editStudentDob"
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">S·ªë ƒëi·ªán tho·∫°i ph·ª• huynh</label>
                    <input type="tel" id="editStudentPhone"
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">L·ªõp</label>
                    <select id="editStudentClass" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                        <option value="">Ch·ªçn l·ªõp</option>
                        <option value="Family & Friends 1">Family & Friends 1</option>
                        <option value="Family & Friends 2">Family & Friends 2</option>
                        <option value="Family & Friends 3">Family & Friends 3</option>
                        <option value="Flyers">Flyers</option>
                        <option value="Movers">Movers</option>
                        <option value="Starters">Starters</option>
                        <option value="Super Minds 1">Super Minds 1</option>
                        <option value="Super Minds 2">Super Minds 2</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tr·∫°ng th√°i</label>
                    <select id="editStudentStatus" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                        <option value="active">ƒêang h·ªçc</option>
                        <option value="inactive">T·∫°m ngh·ªâ</option>
                        <option value="graduated">ƒê√£ t·ªët nghi·ªáp</option>
                    </select>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button type="submit"
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl">
                        <i class="fas fa-save mr-2"></i>C·∫≠p nh·∫≠t
                    </button>
                    <button type="button" onclick="hideEditStudentModal()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-xl">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal s·ª≠a user -->
    <div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è Ch·ªânh s·ª≠a User</h3>
                <button onclick="hideEditUserModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="editUserForm" class="space-y-4">
                <input type="hidden" id="editUserId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√™n hi·ªÉn th·ªã</label>
                    <input type="text" id="editUserDisplayName" required
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" id="editUserPhone"
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ƒê·ªãa ch·ªâ</label>
                    <input type="text" id="editUserAddress"
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i t√†i kho·∫£n</label>
                    <select id="editUserType" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                        <option value="parent">Ph·ª• huynh</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button type="submit"
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl">
                        <i class="fas fa-save mr-2"></i>C·∫≠p nh·∫≠t
                    </button>
                    <button type="button" onclick="hideEditUserModal()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-xl">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal x√°c nh·∫≠n x√≥a -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">X√°c nh·∫≠n x√≥a</h3>
                <p class="text-gray-600 mb-6">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc sinh n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
                <div class="flex gap-3">
                    <button onclick="confirmDelete()" 
                            class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-xl">
                        <i class="fas fa-trash mr-2"></i>X√≥a
                    </button>
                    <button onclick="hideDeleteModal()" 
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-xl">
                        H·ªßy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script type="module">
        // IMPORTS
        import { auth, db } from './firebase-config.js';
        import { signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { 
            getUserById, 
            getAllUsers, 
            getAllStudents, 
            createStudent,
            updateUser,
            updateUserRole,
            softDeleteUser,
            restoreUser,
            updateLastLogin,
            deleteStudent,
            updateStudent
        } from './firestore-service.js';

        // ========== BI·∫æN TO√ÄN C·ª§C ==========
        let currentUser = null;
        let currentUserData = null;
        let isSubmitting = false;
        let currentStudentsList = [];
        let currentUsersList = [];
        let studentToDelete = null;

        // ========== KI·ªÇM TRA ƒêƒÇNG NH·∫¨P ==========
        if (!localStorage.getItem('isLoggedIn')) {
            console.log("Ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn v·ªÅ login");
            window.location.href = 'login.html';
        }

        // ========== KH·ªûI T·∫†O DASHBOARD ==========
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log("‚úÖ User ƒë√£ ƒëƒÉng nh·∫≠p:", user.uid);
                
                await loadUserInfo();
                await loadStatistics();
            } else {
                console.log("‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn v·ªÅ login");
                handleLogout();
            }
        });

        // ========== LOAD TH√îNG TIN USER ==========
        async function loadUserInfo() {
            try {
                if (!currentUser) {
                    console.error("Kh√¥ng c√≥ currentUser");
                    return;
                }
                
                console.log("ƒêang load th√¥ng tin user...");
                const result = await getUserById(currentUser.uid);
                
                if (result.success) {
                    currentUserData = result.data;
                    console.log("‚úÖ Th√¥ng tin user:", currentUserData);
                    
                    const displayName = currentUserData.displayName || 'H·ªçc vi√™n';
                    
                    const hour = new Date().getHours();
                    let greeting = 'Xin ch√†o';
                    if (hour < 12) greeting = 'Ch√†o bu·ªïi s√°ng';
                    else if (hour < 18) greeting = 'Ch√†o bu·ªïi chi·ªÅu';
                    else greeting = 'Ch√†o bu·ªïi t·ªëi';
                    
                    const greetingElement = document.getElementById('greeting');
                    if (greetingElement) {
                        greetingElement.innerHTML = `${greeting}, <span class="text-blue-500 font-bold">${displayName}</span>! üëã`;
                    }
                    
                    const welcomeElement = document.getElementById('welcomeMessage');
                    if (welcomeElement) {
                        welcomeElement.textContent = 'Ch√†o m·ª´ng b·∫°n quay tr·ªü l·∫°i h·ªá th·ªëng';
                    }
                    
                    const typeBadge = document.getElementById('userTypeBadge');
                    if (typeBadge) {
                        if (currentUserData.type === 'admin') {
                            typeBadge.textContent = 'Qu·∫£n tr·ªã vi√™n';
                            typeBadge.className = 'px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-medium';
                        } else {
                            typeBadge.textContent = 'Ph·ª• huynh';
                            typeBadge.className = 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium';
                        }
                    }
                    
                    const sidebarInfo = document.getElementById('sidebarUserInfo');
                    if (sidebarInfo) {
                        sidebarInfo.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 ${currentUserData.type === 'admin' ? 'bg-orange-100' : 'bg-blue-100'} rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-${currentUserData.type === 'admin' ? 'orange' : 'blue'}-500"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-gray-800 truncate">${displayName}</p>
                                    <p class="text-xs text-gray-500 truncate">${currentUserData.type === 'admin' ? 'Qu·∫£n tr·ªã vi√™n' : 'Ph·ª• huynh'}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    const adminMenu = document.getElementById('adminMenuSection');
                    if (adminMenu) {
                        if (currentUserData.type === 'admin') {
                            adminMenu.classList.remove('hidden');
                        } else {
                            adminMenu.classList.add('hidden');
                        }
                    }
                    
                    updateLastLogin(currentUser.uid).catch(err => 
                        console.log("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t last login:", err)
                    );
                    
                } else {
                    console.error("‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin user:", result.error);
                    
                    const displayName = localStorage.getItem('userDisplayName') || 'H·ªçc vi√™n';
                    const greetingElement = document.getElementById('greeting');
                    if (greetingElement) {
                        greetingElement.innerHTML = `Xin ch√†o, <span class="text-blue-500">${displayName}</span>! üëã`;
                    }
                }
            } catch (error) {
                console.error('‚ùå L·ªói load user info:', error);
            }
        }

        // ========== LOAD TH·ªêNG K√ä ==========
        async function loadStatistics() {
            try {
                const studentsResult = await getAllStudents();
                const totalStudents = studentsResult.success ? studentsResult.data.length : 0;
                
                const statsDiv = document.getElementById('statistics');
                if (statsDiv) {
                    statsDiv.innerHTML = `
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white">
                            <i class="fas fa-users text-3xl mb-3"></i>
                            <h3 class="text-lg font-medium opacity-90">T·ªïng h·ªçc sinh</h3>
                            <p class="text-3xl font-bold">${totalStudents}</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white">
                            <i class="fas fa-star text-3xl mb-3"></i>
                            <h3 class="text-lg font-medium opacity-90">ƒê√°nh gi√° trung b√¨nh</h3>
                            <p class="text-3xl font-bold">-</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white">
                            <i class="fas fa-money-bill-wave text-3xl mb-3"></i>
                            <h3 class="text-lg font-medium opacity-90">H·ªçc ph√≠ th√°ng n√†y</h3>
                            <p class="text-3xl font-bold">0ƒë</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå L·ªói load statistics:', error);
            }
        }

        // ========== LOAD DANH S√ÅCH H·ªåC SINH ==========
        async function loadStudents() {
            const studentsList = document.getElementById('studentsList');
            if (!studentsList) return;
            
            try {
                studentsList.innerHTML = '<p class="text-gray-500 text-center py-8">ƒêang t·∫£i d·ªØ li·ªáu...</p>';
                
                const result = await getAllStudents();
                
                if (result.success && result.data.length > 0) {
                    currentStudentsList = result.data;
                    
                    studentsList.innerHTML = result.data.map((student) => `
                        <div class="p-4 border rounded-lg hover:shadow-md transition bg-white" data-student-id="${student.id}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${student.fullName || 'Ch∆∞a c√≥ t√™n'}</h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <span class="font-medium">Nickname:</span> ${student.nickname || 'Ch∆∞a c√≥'}
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <span class="font-medium">L·ªõp:</span> ${student.classGroup || 'Ch∆∞a x·∫øp l·ªõp'}
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <span class="font-medium">SƒêT:</span> ${student.phone || 'Ch∆∞a c√≥'}
                                    </p>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <span class="px-3 py-1 ${student.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} rounded-full text-xs font-medium">
                                        ${student.status === 'active' ? 'ƒêang h·ªçc' : student.status === 'inactive' ? 'T·∫°m ngh·ªâ' : 'ƒê√£ t·ªët nghi·ªáp'}
                                    </span>
                                    <div class="flex gap-2">
                                        ${currentUserData?.type === 'admin' ? `
                                            <button onclick="showEditStudentModal('${student.id}')" 
                                                    class="text-blue-500 hover:text-blue-700 text-sm bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded-lg transition">
                                                <i class="fas fa-edit"></i> S·ª≠a
                                            </button>
                                            <button onclick="deleteStudent('${student.id}')" 
                                                    class="text-red-500 hover:text-red-700 text-sm bg-red-50 hover:bg-red-100 px-3 py-1 rounded-lg transition">
                                                <i class="fas fa-trash"></i> X√≥a
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    studentsList.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ h·ªçc sinh n√†o. H√£y th√™m h·ªçc sinh m·ªõi!</p>';
                }
            } catch (error) {
                console.error('‚ùå L·ªói load students:', error);
                studentsList.innerHTML = '<p class="text-red-500 text-center py-8">L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message + '</p>';
            }
        }

        // ========== LOAD DANH S√ÅCH USERS ==========
        async function loadUsers() {
            const usersList = document.getElementById('usersList');
            if (!usersList) return;
            
            if (!currentUserData || currentUserData.type !== 'admin') {
                usersList.innerHTML = '<p class="text-red-500 text-center py-8">B·∫°n kh√¥ng c√≥ quy·ªÅn xem trang n√†y</p>';
                return;
            }
            
            try {
                usersList.innerHTML = '<p class="text-gray-500 text-center py-8">ƒêang t·∫£i d·ªØ li·ªáu...</p>';
                
                const result = await getAllUsers();
                
                if (result.success && result.data.length > 0) {
                    currentUsersList = result.data;
                    
                    usersList.innerHTML = result.data.map(user => {
                        let createdAt = '';
                        if (user.createdAt) {
                            try {
                                const date = user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt);
                                createdAt = date.toLocaleDateString('vi-VN');
                            } catch (e) {
                                createdAt = 'Kh√¥ng r√µ';
                            }
                        }
                        
                        return `
                        <div class="p-4 border rounded-lg hover:shadow-md transition bg-white">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${user.displayName || 'Ch∆∞a c√≥ t√™n'}</h3>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <span class="font-medium">Username:</span> ${user.username || 'Ch∆∞a c√≥'}
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <span class="font-medium">Lo·∫°i:</span>
                                        <span class="ml-1 px-2 py-1 ${user.type === 'admin' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'} rounded-full text-xs">
                                            ${user.type === 'admin' ? 'Admin' : 'Ph·ª• huynh'}
                                        </span>
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <span class="font-medium">Tr·∫°ng th√°i:</span> 
                                        <span class="ml-1">${user.isActive ? '‚úÖ Ho·∫°t ƒë·ªông' : '‚ùå ƒê√£ x√≥a'}</span>
                                    </p>
                                    <p class="text-xs text-gray-400 mt-1">Tham gia: ${createdAt}</p>
                                </div>
                                <div class="flex flex-col gap-2">
                                    ${user.id !== currentUser.uid ? `
                                        <button onclick="showEditUserModal('${user.id}')" 
                                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                                            <i class="fas fa-edit"></i> S·ª≠a
                                        </button>
                                        ${user.type !== 'admin' ? `
                                            <button onclick="makeAdmin('${user.id}')" 
                                                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                                                <i class="fas fa-crown"></i> Set Admin
                                            </button>
                                        ` : `
                                            <button onclick="removeAdmin('${user.id}')" 
                                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                                                <i class="fas fa-user"></i> Remove Admin
                                            </button>
                                        `}
                                        ${user.isActive ? `
                                            <button onclick="deleteUser('${user.id}')" 
                                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                                                <i class="fas fa-trash"></i> X√≥a
                                            </button>
                                        ` : `
                                            <button onclick="restoreUser('${user.id}')" 
                                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                                                <i class="fas fa-undo"></i> Kh√¥i ph·ª•c
                                            </button>
                                        `}
                                    ` : `
                                        <span class="text-sm text-gray-500 italic">T√†i kho·∫£n c·ªßa b·∫°n</span>
                                    `}
                                </div>
                            </div>
                        </div>
                    `}).join('');
                } else {
                    usersList.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o</p>';
                }
            } catch (error) {
                console.error('‚ùå L·ªói load users:', error);
                usersList.innerHTML = '<p class="text-red-500 text-center py-8">L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message + '</p>';
            }
        }

        // ========== H√ÄM X·ª¨ L√ù MODAL ==========
        window.showAddStudentModal = function() {
            const modal = document.getElementById('addStudentModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        };

        window.hideAddStudentModal = function() {
            const modal = document.getElementById('addStudentModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        window.showEditStudentModal = function(studentId) {
            const student = currentStudentsList.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('editStudentId').value = student.id;
            document.getElementById('editStudentFullName').value = student.fullName || '';
            document.getElementById('editStudentNickname').value = student.nickname || '';
            document.getElementById('editStudentPhone').value = student.phone || '';
            document.getElementById('editStudentClass').value = student.classGroup || '';
            document.getElementById('editStudentStatus').value = student.status || 'active';
            
            if (student.dob) {
                document.getElementById('editStudentDob').value = student.dob;
            }
            
            const modal = document.getElementById('editStudentModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.hideEditStudentModal = function() {
            const modal = document.getElementById('editStudentModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('editStudentForm').reset();
        };

        window.showEditUserModal = function(userId) {
            if (!currentUsersList || currentUsersList.length === 0) {
                alert('Danh s√°ch users ch∆∞a ƒë∆∞·ª£c load! Vui l√≤ng th·ª≠ l·∫°i.');
                return;
            }
            
            const user = currentUsersList.find(u => u.id === userId);
            if (!user) {
                alert('Kh√¥ng t√¨m th·∫•y user!');
                return;
            }
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserDisplayName').value = user.displayName || '';
            document.getElementById('editUserPhone').value = user.phone || '';
            document.getElementById('editUserAddress').value = user.address || '';
            document.getElementById('editUserType').value = user.type || 'parent';
            
            const modal = document.getElementById('editUserModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.hideEditUserModal = function() {
            const modal = document.getElementById('editUserModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('editUserForm').reset();
        };

        window.hideDeleteModal = function() {
            const modal = document.getElementById('deleteConfirmModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            studentToDelete = null;
        };

        // ========== X·ª¨ L√ù FORM TH√äM H·ªåC SINH ==========
        const addStudentForm = document.getElementById('addStudentForm');
        if (addStudentForm) {
            addStudentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (isSubmitting) {
                    console.log('ƒêang x·ª≠ l√Ω, vui l√≤ng ƒë·ª£i...');
                    return;
                }
                
                const submitButton = addStudentForm.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                
                try {
                    isSubmitting = true;
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                    
                    const studentData = {
                        fullName: document.getElementById('studentFullName')?.value.trim(),
                        nickname: document.getElementById('studentNickname')?.value.trim(),
                        dob: document.getElementById('studentDob')?.value,
                        phone: document.getElementById('studentPhone')?.value.trim(),
                        classGroup: document.getElementById('studentClass')?.value,
                        status: 'active'
                    };
                    
                    if (!studentData.fullName) {
                        alert('Vui l√≤ng nh·∫≠p h·ªç t√™n h·ªçc sinh!');
                        return;
                    }
                    
                    if (!currentUser) {
                        alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!');
                        return;
                    }
                    
                    const result = await createStudent(studentData, currentUser.uid);
                    
                    if (result.success) {
                        alert('‚úÖ Th√™m h·ªçc sinh th√†nh c√¥ng!');
                        hideAddStudentModal();
                        addStudentForm.reset();
                        await loadStudents();
                        await loadStatistics();
                    } else {
                        alert('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ th√™m h·ªçc sinh'));
                    }
                } catch (error) {
                    console.error('L·ªói khi th√™m h·ªçc sinh:', error);
                    alert('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message);
                } finally {
                    isSubmitting = false;
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        }

        // ========== X·ª¨ L√ù FORM S·ª¨A H·ªåC SINH ==========
        const editStudentForm = document.getElementById('editStudentForm');
        if (editStudentForm) {
            editStudentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const studentId = document.getElementById('editStudentId').value;
                const updateData = {
                    fullName: document.getElementById('editStudentFullName').value.trim(),
                    nickname: document.getElementById('editStudentNickname').value.trim(),
                    dob: document.getElementById('editStudentDob').value,
                    phone: document.getElementById('editStudentPhone').value.trim(),
                    classGroup: document.getElementById('editStudentClass').value,
                    status: document.getElementById('editStudentStatus').value
                };
                
                try {
                    const result = await updateStudent(studentId, updateData);
                    
                    if (result.success) {
                        alert('‚úÖ C·∫≠p nh·∫≠t h·ªçc sinh th√†nh c√¥ng!');
                        hideEditStudentModal();
                        await loadStudents();
                        await loadStatistics();
                    } else {
                        alert('‚ùå L·ªói: ' + result.error);
                    }
                } catch (error) {
                    alert('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message);
                }
            });
        }

        // ========== X·ª¨ L√ù FORM S·ª¨A USER ==========
        const editUserForm = document.getElementById('editUserForm');
        if (editUserForm) {
            editUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const userId = document.getElementById('editUserId').value;
                const updateData = {
                    displayName: document.getElementById('editUserDisplayName').value.trim(),
                    phone: document.getElementById('editUserPhone').value.trim(),
                    address: document.getElementById('editUserAddress').value.trim()
                };
                
                const newType = document.getElementById('editUserType').value;
                
                try {
                    const result = await updateUser(userId, updateData);
                    
                    if (result.success) {
                        const currentUserInList = currentUsersList.find(u => u.id === userId);
                        
                        if (currentUserInList && newType !== currentUserInList.type) {
                            await updateUserRole(userId, newType, currentUser.uid);
                        }
                        
                        alert('‚úÖ C·∫≠p nh·∫≠t user th√†nh c√¥ng!');
                        hideEditUserModal();
                        await loadUsers();
                    } else {
                        alert('‚ùå L·ªói: ' + result.error);
                    }
                } catch (error) {
                    alert('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message);
                }
            });
        }

        // ========== H√ÄM X√ìA H·ªåC SINH ==========
        window.deleteStudent = async function(studentId) {
            if (!currentUserData || currentUserData.type !== 'admin') {
                alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a h·ªçc sinh!');
                return;
            }
            
            studentToDelete = studentId;
            const modal = document.getElementById('deleteConfirmModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        };

        window.confirmDelete = async function() {
            if (!studentToDelete) {
                hideDeleteModal();
                return;
            }
            
            try {
                const result = await deleteStudent(studentToDelete);
                if (result.success) {
                    alert('‚úÖ X√≥a h·ªçc sinh th√†nh c√¥ng!');
                    await loadStudents();
                    await loadStatistics();
                } else {
                    alert('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ x√≥a h·ªçc sinh'));
                }
            } catch (error) {
                alert('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message);
            } finally {
                hideDeleteModal();
            }
        };

        // ========== H√ÄM X·ª¨ L√ù ƒêƒÇNG XU·∫§T ==========
        function handleLogout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userDisplayName');
            localStorage.removeItem('userType');
            localStorage.removeItem('userId');
            window.location.href = 'login.html';
        }

        window.logout = function() {
            signOut(auth).then(handleLogout).catch((error) => {
                console.error('‚ùå L·ªói ƒëƒÉng xu·∫•t:', error);
                handleLogout();
            });
        };

        // ========== H√ÄM TOGGLE SIDEBAR ==========
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }
        };

        // ========== H√ÄM SET ACTIVE MENU ==========
        window.setActiveMenu = async function(element, menuId) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (element) {
                element.classList.add('active');
            }
            
            document.getElementById('homeContent')?.classList.add('hidden');
            document.getElementById('studentsContent')?.classList.add('hidden');
            document.getElementById('assessmentsContent')?.classList.add('hidden');
            document.getElementById('paymentsContent')?.classList.add('hidden');
            document.getElementById('rewardsContent')?.classList.add('hidden');
            document.getElementById('usersContent')?.classList.add('hidden');
            
            const selectedContent = document.getElementById(menuId + 'Content');
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
            }
            
            if (menuId === 'students') {
                await loadStudents();
            } else if (menuId === 'users' && currentUserData?.type === 'admin') {
                await loadUsers();
            }
            
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        };

        // ========== H√ÄM ADMIN ==========
        window.makeAdmin = async function(userId) {
            if (!currentUser) {
                alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën set user n√†y l√†m admin?')) {
                const result = await updateUserRole(userId, 'admin', currentUser.uid);
                if (result.success) {
                    alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t role th√†nh c√¥ng!');
                    await loadUsers();
                } else {
                    alert('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t role'));
                }
            }
        };

        window.removeAdmin = async function(userId) {
            if (!currentUser) {
                alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            if (userId === currentUser.uid) {
                alert('B·∫°n kh√¥ng th·ªÉ t·ª± x√≥a quy·ªÅn Admin c·ªßa ch√≠nh m√¨nh!');
                return;
            }
            
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a quy·ªÅn Admin c·ªßa user n√†y?')) {
                const result = await updateUserRole(userId, 'parent', currentUser.uid);
                if (result.success) {
                    alert('‚úÖ ƒê√£ x√≥a quy·ªÅn Admin th√†nh c√¥ng!');
                    await loadUsers();
                } else {
                    alert('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ x√≥a quy·ªÅn Admin'));
                }
            }
        };

        window.deleteUser = async function(userId) {
            if (!currentUser) {
                alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a user n√†y?')) {
                const result = await softDeleteUser(userId, currentUser.uid);
                if (result.success) {
                    alert('‚úÖ ƒê√£ x√≥a user th√†nh c√¥ng!');
                    await loadUsers();
                } else {
                    alert('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ x√≥a user'));
                }
            }
        };

        window.restoreUser = async function(userId) {
            if (!currentUser) {
                alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën kh√¥i ph·ª•c user n√†y?')) {
                const result = await restoreUser(userId, currentUser.uid);
                if (result.success) {
                    alert('‚úÖ ƒê√£ kh√¥i ph·ª•c user th√†nh c√¥ng!');
                    await loadUsers();
                } else {
                    alert('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ kh√¥i ph·ª•c user'));
                }
            }
        };

        // ========== EVENT LISTENERS ==========
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 1024) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('overlay');
                if (sidebar && overlay) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            }
        });

        const overlay = document.getElementById('overlay');
        if (overlay) {
            overlay.addEventListener('click', toggleSidebar);
        }

        console.log("‚úÖ Dashboard ƒë√£ s·∫µn s√†ng!");
    </script>
</body>
</html>