<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Words Fall - Game d·ªãch thu·∫≠t cho b√©</title>
    <style>
        /* ========== BRAND STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5deb3 0%, #fffacd 50%, #faebd7 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        /* ========== ROTATE WARNING FOR MOBILE ========== */
        .rotate-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 9999;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 24px;
            padding: 20px;
        }

        .rotate-warning .warning-content {
            animation: pulse 2s infinite;
        }

        .rotate-warning .rotate-icon {
            font-size: 64px;
            margin-bottom: 20px;
            display: inline-block;
            animation: rotate 2s infinite;
        }

        @keyframes rotate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* Easy Mode Switch Styles */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f4ff;
            padding: 8px 15px;
            border-radius: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .switch-label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: '';
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #27ae60;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #27ae60;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        #easyModeStatus {
            font-size: 14px;
            font-weight: bold;
            min-width: 45px;
            text-align: center;
        }

        .easy-indicator {
            background: #27ae60;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            animation: softPulse 2s infinite;
        }

        @keyframes softPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            @media (orientation: portrait) {
                .rotate-warning {
                    display: flex;
                }
                .container {
                    display: none;
                }
            }
            
            @media (orientation: landscape) {
                .rotate-warning {
                    display: none;
                }
                
                body {
                    padding: 5px;
                    overflow: hidden;
                    position: fixed;
                    width: 100%;
                    height: 100%;
                }
                
                .container {
                    transform: scale(0.7);
                    transform-origin: top center;
                    padding: 5px;
                    max-width: 142.857%;
                    width: 142.857%;
                    margin-left: -21.4285%;
                    height: auto;
                    max-height: 142.857vh;
                    overflow-y: auto;
                    -webkit-overflow-scrolling: touch;
                }
                
                .game-area {
                    flex-direction: row;
                    gap: 5px;
                    min-height: auto;
                }
                
                .source-area {
                    min-width: 35%;
                    max-height: 280px;
                    padding: 8px;
                }
                
                .source-grid {
                    max-height: 220px;
                    overflow-y: auto;
                    display: flex;
                    flex-wrap: wrap;
                    gap: 5px;
                }
                
                .word-pool-area {
                    min-width: 60%;
                    max-height: 280px;
                    padding: 8px;
                }
                
                .pool-container {
                    height: 230px;
                }
                
                .viet-tile {
                    padding: 6px 8px;
                    font-size: 11px;
                    min-width: 45px;
                    min-height: 32px;
                    margin: 2px;
                }
                
                .english-tile {
                    padding: 5px 7px;
                    font-size: 10px;
                    min-height: 28px;
                    border-radius: 6px;
                }
                
                .english-tile[data-column="0"] { left: 3% !important; }
                .english-tile[data-column="1"] { left: 35% !important; }
                .english-tile[data-column="2"] { left: 67% !important; }
                
                .game-header {
                    flex-direction: row;
                    gap: 5px;
                    margin-bottom: 8px;
                }
                
                .scoreboard {
                    padding: 5px 8px;
                    gap: 8px;
                }
                
                .score-item {
                    min-width: 50px;
                }
                
                .score-label {
                    font-size: 9px;
                }
                
                .score-value {
                    font-size: 16px;
                }
                
                .timer-section {
                    padding: 5px 10px;
                    gap: 8px;
                }
                
                .timer {
                    font-size: 20px;
                    min-width: 45px;
                }
                
                .hint-count {
                    padding: 3px 8px;
                    font-size: 11px;
                }
                
                .game-info-bar {
                    padding: 5px 10px;
                    margin-bottom: 8px;
                    font-size: 11px;
                }
                
                .game-controls {
                    gap: 5px;
                    margin: 8px 0;
                }
                
                .btn {
                    padding: 6px 10px;
                    font-size: 11px;
                }
                
                .switch {
                    width: 50px !important;
                    height: 28px !important;
                }
                
                .slider:before {
                    height: 22px !important;
                    width: 22px !important;
                }
                
                .switch-container {
                    padding: 5px 10px;
                }
                
                .switch-label {
                    font-size: 11px;
                }
                
                #easyModeStatus {
                    font-size: 11px;
                    min-width: 35px;
                }
                
                .logo-container {
                    transform: scale(0.5);
                    bottom: 2px;
                    right: 2px;
                }
                
                .result-content {
                    transform: scale(0.8);
                    padding: 15px;
                }
                
                .result-title {
                    font-size: 24px;
                }
                
                .stat-row {
                    font-size: 12px;
                }
                
                .translated-text {
                    max-height: 120px;
                    font-size: 12px;
                }
                
                .preview-content {
                    flex-direction: column;
                }
                
                .preview-box {
                    min-width: 100%;
                }
                
                .preview-text {
                    font-size: 11px;
                    max-height: 80px;
                    overflow-y: auto;
                }
                
                .mode-section h2 {
                    font-size: 16px;
                }
                
                .mode-btn {
                    padding: 8px 12px;
                    font-size: 11px;
                }
                
                .vocab-select {
                    padding: 6px 8px;
                    font-size: 11px;
                    min-width: 120px;
                }
                
                .vocab-status {
                    font-size: 11px;
                    padding: 6px;
                }
                
                .stack-level {
                    height: 1px;
                }
                
                #poolWarning {
                    font-size: 10px;
                    padding: 3px;
                }
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                transform: scale(0.85);
                transform-origin: top center;
            }
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
            transition: all 0.3s;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 15px;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .game-title-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .game-title-logo img {
            height: 120px;
            width: auto;
            object-fit: contain;
        }

        .mode-section {
            margin-bottom: 25px;
        }

        .mode-section h2 {
            color: #764ba2;
            margin-bottom: 5px;
            font-size: 1.5em;
            text-align: center;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #555;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .mode-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .mode-btn.vi-en {
            border-color: #27ae60;
        }

        .mode-btn.vi-en.selected {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .mode-btn.en-vi {
            border-color: #3498db;
        }

        .mode-btn.en-vi.selected {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .mode-info {
            background: #f0f4ff;
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
            color: #555;
            text-align: center;
        }

        .vocabulary-section {
            margin: 10px 0;
            text-align: center;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #3498db;
            padding: 15px;
        }

        .vocab-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }

        .status-loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .vocab-preview {
            background: #d4edda;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            color: #155724;
            border: 1px solid #c3e6cb;
            text-align: center;
            margin: 10px 0;
        }

        .vocab-controls {
            display: flex;
            gap: 15px;
            margin: 5px 0;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .vocab-select {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            min-width: 180px;
            cursor: pointer;
        }

        .vocab-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .preview-section {
            background: #f8f9fa;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .preview-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .preview-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .preview-box {
            flex: 1;
            min-width: 250px;
            background: white;
            border-radius: 8px;
            padding: 12px;
            border-left: 5px solid;
        }

        .preview-box.vi {
            border-left-color: #27ae60;
        }

        .preview-box.en {
            border-left-color: #3498db;
        }

        .preview-box h4 {
            margin-bottom: 8px;
            color: #555;
        }

        .preview-text {
            background: #f1f8ff;
            padding: 10px;
            border-radius: 6px;
            font-size: 15px;
            line-height: 1.6;
            word-break: break-word;
        }

        .btn {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .game-section {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .scoreboard {
            display: flex;
            gap: 20px;
            align-items: center;
            background: linear-gradient(135deg, #f5deb3 0%, #faebd7 100%);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        .timer-section {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(0deg, #f5deb3 0%, #faebd7 100%);
            padding: 10px 20px;
            border-radius: 12px;
            color: #6b4ba2;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .timer {
            font-size: 32px;
            font-weight: bold;
            min-width: 70px;
            text-align: center;
        }

        .timer.warning {
            color: #f39c12;
            animation: timerPulse 1s infinite;
        }

        .timer.danger {
            color: #e74c3c;
            animation: timerPulse 0.5s infinite;
        }

        .hint-count {
            background: #9b59b6;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .game-info-bar {
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .level-info {
            font-weight: bold;
            color: #2c3e50;
        }

        .progress-info {
            color: #27ae60;
            font-weight: bold;
        }

        .game-area {
            display: flex;
            gap: 20px;
            min-height: 500px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .source-area {
            flex: 1;
            min-width: 350px;
            background: #f8f9fa;
            border: 3px solid #3498db;
            border-radius: 15px;
            padding: 15px;
            max-height: 550px;
            overflow-y: auto;
        }

        .source-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            justify-content: space-between;
        }

        .source-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .viet-tile {
            padding: 12px 15px;
            background: #fff3cd;
            border: 2px solid #f39c12;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            color: #856404;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            min-width: 80px;
            text-align: center;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .viet-tile:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .viet-tile.filled {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
            opacity: 0.7;
            cursor: default;
        }

        .viet-tile.highlight {
            animation: highlight-pulse 1s infinite;
            border-color: #9b59b6;
            background: #e8daef;
        }

        .viet-tile.matched {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
            position: relative;
        }

        .viet-tile.matched::after {
            content: '‚úì';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #27ae60;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .word-pool-area {
            flex: 1;
            min-width: 300px;
            background: #f8f9fa;
            border: 3px solid #e74c3c;
            border-radius: 15px;
            padding: 15px;
            position: relative;
            max-height: 550px;
            overflow: hidden;
        }

        .pool-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e74c3c;
        }

        .pool-container {
            position: relative;
            height: 450px;
            overflow: hidden;
            background: rgba(255,255,255,0.5);
            border-radius: 10px;
            border: 1px dashed #e74c3c;
        }

        .falling-words {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .english-tile {
            position: absolute;
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.1s;
            z-index: 10;
            white-space: nowrap;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 2px solid transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .english-tile:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .english-tile.selected {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px white, 0 0 0 6px #f39c12, 0 6px 12px rgba(0,0,0,0.3);
            z-index: 20;
            border-color: #f39c12;
        }

        .english-tile.highlight {
            animation: highlight-pulse 1s infinite;
            border: 3px solid white;
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }

        .pool-warning {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            color: #e74c3c;
            font-weight: bold;
            animation: warningPulse 1s infinite;
            background: rgba(255,255,255,0.8);
            padding: 5px;
            border-radius: 20px;
            z-index: 100;
        }

        .stack-level {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(231, 76, 60, 0.3);
            z-index: 5;
            pointer-events: none;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .pause-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .pause-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            animation: bounce 1s;
        }

        .pause-content h2 {
            font-size: 48px;
            color: #f39c12;
            margin-bottom: 20px;
        }

        .result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .result-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            animation: bounce 1s;
        }

        .result-content.win {
            border-top: 10px solid #27ae60;
        }

        .result-content.lose {
            border-top: 10px solid #e74c3c;
        }

        .result-title {
            font-size: 32px;
            margin-bottom: 20px;
        }

        .result-stats {
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
            padding: 15px;
            text-align: left;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .translated-text {
            background: #f1f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            line-height: 1.8;
            font-size: 16px;
        }

        .translated-text span {
            display: inline-block;
            margin: 0 2px;
        }

        .translated-text .filled-word {
            background: #d4edda;
            padding: 2px 5px;
            border-radius: 4px;
            color: #155724;
        }

        .translated-text .empty-word {
            background: #f8d7da;
            padding: 2px 5px;
            border-radius: 4px;
            color: #721c24;
        }

        .logo-container {
            position: fixed;
            bottom: 15px;
            right: 15px;
            z-index: 999;
            animation: swing 3s ease-in-out infinite;
        }

        .logo-container img {
            width: 120px;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
        }

        /* ========== HI·ªÜU ·ª®NG KHI D·ªäCH ƒê√öNG ========== */
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px #27ae60; }
            100% { transform: scale(1); }
        }

        @keyframes floatStar {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100px) rotate(720deg); opacity: 0; }
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .correct-effect {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            font-size: 24px;
            animation: floatStar 1s ease-out forwards;
        }

        .correct-effect.star {
            color: gold;
            filter: drop-shadow(0 0 5px gold);
        }

        .correct-effect.emoji {
            font-size: 30px;
        }

        .confetti-particle {
            position: fixed;
            pointer-events: none;
            z-index: 9998;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: confetti 2s ease-out forwards;
        }

        .screen-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9997;
            animation: flashFade 0.3s ease-out forwards;
        }

        @keyframes flashFade {
            0% { background: radial-gradient(circle, rgba(39, 174, 96, 0.5) 0%, transparent 70%); opacity: 1; }
            100% { opacity: 0; }
        }

        .combo-text {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: gold;
            text-shadow: 0 0 20px orange, 0 0 40px red;
            z-index: 10000;
            pointer-events: none;
            animation: comboPop 1s ease-out forwards;
            white-space: nowrap;
        }

        @keyframes comboPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes highlight-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.7);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 20px 5px rgba(155, 89, 182, 0.7);
            }
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes swing {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            75% { transform: rotate(-10deg); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .game-title-logo img { height: 90px; }
            .logo-container { bottom: 5px; right: 5px; }
            .logo-container img { width: 90px; }
        }
    </style>
</head>
<body>
    <div class="rotate-warning">
        <div class="warning-content">
            <div class="rotate-icon">üîÑ</div>
            <h2>Vui l√≤ng xoay ngang ƒëi·ªán tho·∫°i</h2>
            <p>Please rotate your device to landscape mode</p>
            <small>Game ƒë∆∞·ª£c t·ªëi ∆∞u cho ch·∫ø ƒë·ªô ngang</small>
        </div>
    </div>

    <div class="container">
        <div class="setup-section" id="setupSection">
            <div class="game-title-logo">
                <img src="words-fall.png" alt="Words Fall Logo" onerror="this.style.display='none'">
                <h1>Words Fall for Kids</h1>
            </div>

            <div class="mode-section">
                <h2>üåç Ch·ªçn ch·∫ø ƒë·ªô d·ªãch</h2>
                <div class="mode-selector">
                    <button class="mode-btn vi-en selected" onclick="selectTranslationMode('vi-en')">
                        üáªüá≥ VI·ªÜT ‚Üí ANH üá¨üáß
                    </button>
                    <button class="mode-btn en-vi" onclick="selectTranslationMode('en-vi')">
                        üá¨üáß ANH ‚Üí VI·ªÜT üáªüá≥
                    </button>
                </div>
                <div class="mode-info" id="modeInfo">
                    <strong>VI·ªÜT ‚Üí ANH:</strong> D·ªãch ƒëo·∫°n vƒÉn t·ª´ ti·∫øng Vi·ªát sang ti·∫øng Anh
                </div>
            </div>

            <div class="vocabulary-section">                              
                <div class="vocab-controls">
                    <div id="vocabStatus" class="vocab-status status-loading">
                        ‚è≥ Loading stories from file...
                    </div>
                    <select id="levelSelect" class="vocab-select" disabled>
                        <option value="">-- Ch·ªçn Level --</option>
                    </select>
                    
                    <select id="unitSelect" class="vocab-select" disabled>
                        <option value="">-- Ch·ªçn Story --</option>
                    </select>
                    
                    <button class="btn btn-primary" onclick="loadStory()" id="loadBtn" disabled>
                        üìñ LOAD STORY
                    </button>
                </div>
            </div>

            <div id="previewSection" class="preview-section" style="display: none;">
                <div class="preview-title">üìã Preview ƒëo·∫°n vƒÉn:</div>
                <div class="preview-content">
                    <div class="preview-box vi">
                        <h4>üáªüá≥ Ti·∫øng Vi·ªát</h4>
                        <div id="previewVi" class="preview-text"></div>
                    </div>
                    <div class="preview-box en">
                        <h4>üá¨üáß Ti·∫øng Anh</h4>
                        <div id="previewEn" class="preview-text"></div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="startGame()" id="startBtn" disabled>
                        üöÄ B·∫ÆT ƒê·∫¶U D·ªäCH!
                    </button>
                    
                    <div class="switch-container">
                        <span class="switch-label">üåü Ch·∫ø ƒë·ªô d·ªÖ:</span>
                        <label class="switch">
                            <input type="checkbox" id="easyModeSwitch">
                            <span class="slider"></span>
                        </label>
                        <span id="easyModeStatus" style="color: #e74c3c;">T·∫ÆT</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-section" id="gameSection">
            <div class="game-header">
                <div class="scoreboard">
                    <div class="score-item">
                        <div class="score-label">‚≠ê ƒêI·ªÇM</div>
                        <div class="score-value" id="score">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">üî• COMBO</div>
                        <div class="score-value" id="combo">x0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">üîç HINT</div>
                        <div class="score-value" id="hintLeft">3</div>
                    </div>
                </div>
                
                <div class="timer-section">
                    <div class="timer" id="timer">0</div>
                    <div class="hint-count" id="bonusInfo">+0</div>
                </div>
            </div>

            <div class="game-info-bar">
                <div class="level-info" id="gameLevel"></div>
                <div class="progress-info" id="gameProgress">0/0 t·ª´ ƒë√£ d·ªãch</div>
                <div id="easyModeIndicator" class="easy-indicator" style="display: none;">üåü D·ªÑ</div>
            </div>

            <div class="game-area">
                <div class="source-area">
                    <div class="source-title">
                        <span id="sourceLang">üáªüá≥ Ti·∫øng Vi·ªát</span>
                        <span id="sourceCount">0/0 t·ª´</span>
                    </div>
                    <div class="source-grid" id="sourceGrid"></div>
                </div>

                <div class="word-pool-area">
                    <div class="pool-title">
                        <span id="poolLang">üá¨üáß Ti·∫øng Anh r∆°i</span>
                    </div>
                    <div class="pool-container">
                        <div class="falling-words" id="fallingWords"></div>
                        <div id="poolWarning" class="pool-warning" style="display: none;">‚ö†Ô∏è S·∫Øp ƒë·∫ßy!</div>
                    </div>
                </div>
            </div>

            <div class="game-controls">
                <button class="btn btn-info" onclick="useHint()" id="hintBtn">
                    üîç HINT (<span id="hintCount">3</span>)
                </button>
                <button class="btn btn-warning" onclick="pauseGame()" id="pauseBtn">
                    ‚è∏Ô∏è PAUSE
                </button>
                <button class="btn btn-danger" onclick="endGame('lose')" id="quitBtn">
                    üö™ THO√ÅT
                </button>
            </div>
        </div>

        <div class="pause-overlay" id="pauseOverlay">
            <div class="pause-content">
                <h2>‚è∏Ô∏è GAME PAUSED</h2>
                <p style="margin-bottom: 20px;">Nh·∫•n ti·∫øp t·ª•c ƒë·ªÉ ch∆°i ti·∫øp</p>
                <button class="btn btn-success" onclick="resumeGame()">‚ñ∂Ô∏è TI·∫æP T·ª§C</button>
            </div>
        </div>

        <div class="result-modal" id="resultModal">
            <div class="result-content" id="resultContent">
                <div class="result-title" id="resultTitle">üèÜ HO√ÄN TH√ÄNH!</div>
                
                <div id="resultStats" class="result-stats"></div>

                <div class="translated-text" id="translatedText"></div>

                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="playAgain()">üîÑ CH∆†I L·∫†I</button>
                    <button class="btn btn-info" onclick="backToMenu()">üìã MENU</button>
                </div>
            </div>
        </div>
    </div>

    <div class="logo-container">
        <img src="logo.png" alt="Brand Logo" onerror="this.style.display='none'">
    </div>

    <script>
        // ========== GAME VARIABLES ==========
        let translationMode = 'vi-en';
        let vocabularyData = "";
        let vocabularyStructure = {};
        let selectedLevel = "";
        let selectedUnit = "";
        let currentStory = null;
        let easyMode = false;
        
        let score = 0;
        let combo = 0;
        let hintCount = 3;
        let timeElapsed = 0;
        let timerInterval = null;
        let isPaused = false;
        let isGameActive = false;
        
        // Index-based mapping
        let translationMap = {};      // Key: index, Value: ƒë√°p √°n (ti·∫øng Anh ho·∫∑c Vi·ªát)
        let displayMap = {};          // Key: index, Value: t·ª´ hi·ªÉn th·ªã (ng√¥n ng·ªØ ngu·ªìn)
        let totalWords = 0;
        
        // C∆° ch·∫ø ƒë·∫øm s·ªë l∆∞·ª£ng t·ª´
        let englishWordCount = {};    // ƒê·∫øm s·ªë l∆∞·ª£ng m·ªói t·ª´ ti·∫øng Anh c√≤n l·∫°i
        let vietWordNeeds = {};       // M·ªói v·ªã tr√≠ ti·∫øng Vi·ªát c·∫ßn t·ª´ g√¨
        
        let remainingEnglishWords = []; // M·∫£ng c√°c t·ª´ ti·∫øng Anh c·∫ßn r∆°i xu·ªëng
        let activeEnglishWords = [];
        
        let columns = 3;
        let columnHeights = [0, 0, 0];
        let columnWords = [[], [], []];
        
        let selectedEnglishTile = null;
        let selectedVietnameseTile = null;
        
        let fallingInterval = null;
        let animationFrame = null;
        
        const rightSound = new Audio('right.mp3');
        const wrongSound = new Audio('wrong.mp3');
        const winSound = new Audio('win.mp3');

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadVocabularyFile();
            setupMobileTouchEvents();
            
            const easySwitch = document.getElementById('easyModeSwitch');
            if (easySwitch) {
                easySwitch.addEventListener('change', function() {
                    easyMode = this.checked;
                    const statusEl = document.getElementById('easyModeStatus');
                    statusEl.textContent = easyMode ? 'B·∫¨T' : 'T·∫ÆT';
                    statusEl.style.color = easyMode ? '#27ae60' : '#e74c3c';
                    
                    showToast(easyMode ? 'üåü Ch·∫ø ƒë·ªô d·ªÖ: KH√îNG THUA khi stack ƒë·∫ßy' : 'üî∞ Ch·∫ø ƒë·ªô th∆∞·ªùng: C√≥ th·ªÉ thua khi stack ƒë·∫ßy', 
                             easyMode ? '#27ae60' : '#3498db');
                });
            }
        });

        function setupMobileTouchEvents() {
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('.pool-container') || e.target.closest('.source-grid')) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        function showToast(message, bgColor) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${bgColor};
                color: white;
                padding: 10px 20px;
                border-radius: 30px;
                z-index: 3000;
                font-size: 14px;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: fadeInOut 3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        async function loadVocabularyFile() {
            const statusDiv = document.getElementById('vocabStatus');
            const levelSelect = document.getElementById('levelSelect');
            const unitSelect = document.getElementById('unitSelect');
            const loadBtn = document.getElementById('loadBtn');
            const startBtn = document.getElementById('startBtn');
            
            try {
                statusDiv.className = 'vocab-status status-loading';
                statusDiv.textContent = '‚è≥ Loading stories from file...';
                
                let response = await fetch('text.txt');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const fileContent = await response.text();
                
                if (!fileContent.trim()) {
                    throw new Error('File is empty');
                }
                
                vocabularyData = fileContent;
                parseVocabularyStructure();
                
                statusDiv.className = 'vocab-status status-success';
                statusDiv.textContent = '‚úÖ File loaded!';
                
                levelSelect.disabled = false;
                levelSelect.innerHTML = '<option value="">-- Ch·ªçn Level --</option>';
                
                for (const level in vocabularyStructure) {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = level;
                    levelSelect.appendChild(option);
                }
                
                levelSelect.addEventListener('change', function() {
                    if (this.value) {
                        unitSelect.disabled = false;
                        unitSelect.innerHTML = '<option value="">-- Ch·ªçn Story --</option>';
                        const units = Object.keys(vocabularyStructure[this.value]);
                        units.forEach(unit => {
                            const option = document.createElement('option');
                            option.value = unit;
                            option.textContent = unit;
                            unitSelect.appendChild(option);
                        });
                    } else {
                        unitSelect.disabled = true;
                        loadBtn.disabled = true;
                        startBtn.disabled = true;
                    }
                });
                
                unitSelect.addEventListener('change', function() {
                    if (levelSelect.value && this.value) {
                        loadBtn.disabled = false;
                    } else {
                        loadBtn.disabled = true;
                    }
                });
                
            } catch (error) {
                console.error('Error loading file:', error);
                statusDiv.className = 'vocab-status status-error';
                statusDiv.textContent = '‚ùå Error loading file. Please check text.txt';
            }
        }
        
        function parseVocabularyStructure() {
            vocabularyStructure = {};
            const lines = vocabularyData.split('\n');
            let currentLevel = '';
            let currentUnit = '';
            let currentVi = [];
            let currentEn = [];
            
            for (let line of lines) {
                line = line.trim();
                
                if (line.startsWith('===') && line.endsWith('===')) {
                    if (currentUnit && currentVi.length > 0 && currentEn.length > 0) {
                        if (!vocabularyStructure[currentLevel]) {
                            vocabularyStructure[currentLevel] = {};
                        }
                        vocabularyStructure[currentLevel][currentUnit] = {
                            vi: currentVi,
                            en: currentEn
                        };
                    }
                    
                    currentLevel = line.replace(/===/g, '').trim();
                    currentUnit = '';
                    currentVi = [];
                    currentEn = [];
                }
                else if (line.startsWith('[') && line.endsWith(']') && !line.startsWith('[VN]') && !line.startsWith('[EN]')) {
                    if (currentUnit && currentVi.length > 0 && currentEn.length > 0) {
                        if (!vocabularyStructure[currentLevel]) {
                            vocabularyStructure[currentLevel] = {};
                        }
                        vocabularyStructure[currentLevel][currentUnit] = {
                            vi: currentVi,
                            en: currentEn
                        };
                    }
                    
                    currentUnit = line.slice(1, -1).trim();
                    currentVi = [];
                    currentEn = [];
                }
                else if (line.startsWith('[VN]')) {
                    const content = line.substring(4).trim();
                    currentVi = content.split('|').map(s => s.trim()).filter(s => s);
                }
                else if (line.startsWith('[EN]')) {
                    const content = line.substring(4).trim();
                    currentEn = content.split('|').map(s => s.trim()).filter(s => s);
                }
            }
            
            // L∆∞u unit cu·ªëi c√πng
            if (currentUnit && currentVi.length > 0 && currentEn.length > 0) {
                if (!vocabularyStructure[currentLevel]) {
                    vocabularyStructure[currentLevel] = {};
                }
                vocabularyStructure[currentLevel][currentUnit] = {
                    vi: currentVi,
                    en: currentEn
                };
            }
        }
        
        function selectTranslationMode(mode) {
            translationMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            const infoText = {
                'vi-en': '<strong>VI·ªÜT ‚Üí ANH:</strong> D·ªãch ƒëo·∫°n vƒÉn t·ª´ ti·∫øng Vi·ªát sang ti·∫øng Anh',
                'en-vi': '<strong>ANH ‚Üí VI·ªÜT:</strong> D·ªãch ƒëo·∫°n vƒÉn t·ª´ ti·∫øng Anh sang ti·∫øng Vi·ªát'
            };
            document.getElementById('modeInfo').innerHTML = infoText[mode];
        }
        
        function loadStory() {
            const level = document.getElementById('levelSelect').value;
            const unit = document.getElementById('unitSelect').value;
            const startBtn = document.getElementById('startBtn');
            const previewSection = document.getElementById('previewSection');
            
            if (!level || !unit) {
                alert('Please select both Level and Story');
                return;
            }
            
            selectedLevel = level;
            selectedUnit = unit;
            
            const story = vocabularyStructure[level][unit];
            if (!story) {
                alert('Story not found!');
                return;
            }
            
            currentStory = story;
            
            document.getElementById('previewVi').textContent = story.vi.join(' ');
            document.getElementById('previewEn').textContent = story.en.join(' ');
            previewSection.style.display = 'block';
            
            startBtn.disabled = false;
        }
        
        function startGame() {
            if (!currentStory) {
                alert('Please load a story first!');
                return;
            }
            
            score = 0;
            combo = 0;
            hintCount = 3;
            timeElapsed = 0;
            isPaused = false;
            isGameActive = true;
            selectedEnglishTile = null;
            selectedVietnameseTile = null;
            
            easyMode = document.getElementById('easyModeSwitch').checked;
            
            columnHeights = [0, 0, 0];
            columnWords = [[], [], []];
            activeEnglishWords = [];
            
            // Kh·ªüi t·∫°o ƒë·∫øm s·ªë l∆∞·ª£ng
            englishWordCount = {};
            vietWordNeeds = {};
            
            document.getElementById('score').textContent = score;
            document.getElementById('combo').textContent = 'x0';
            document.getElementById('hintLeft').textContent = hintCount;
            document.getElementById('hintCount').textContent = hintCount;
            document.getElementById('timer').textContent = timeElapsed;
            document.getElementById('timer').classList.remove('warning', 'danger');
            document.getElementById('fallingWords').innerHTML = '';
            document.getElementById('gameLevel').textContent = `${selectedLevel} - ${selectedUnit}`;
            
            const easyIndicator = document.getElementById('easyModeIndicator');
            if (easyMode) {
                easyIndicator.style.display = 'block';
                easyIndicator.style.background = '#27ae60';
                easyIndicator.textContent = 'üåü D·ªÑ';
            } else {
                easyIndicator.style.display = 'none';
            }
            
            // Kh·ªüi t·∫°o index-based maps
            translationMap = {};
            displayMap = {};
            
            if (translationMode === 'vi-en') {
                // Ch·∫ø ƒë·ªô Vi·ªát -> Anh
                for (let i = 0; i < currentStory.vi.length; i++) {
                    const englishWord = currentStory.en[i];
                    translationMap[i] = englishWord;
                    displayMap[i] = currentStory.vi[i];
                    
                    // ƒê·∫øm s·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa m·ªói t·ª´ ti·∫øng Anh
                    englishWordCount[englishWord] = (englishWordCount[englishWord] || 0) + 1;
                    
                    // L∆∞u nhu c·∫ßu c·ªßa v·ªã tr√≠ ti·∫øng Vi·ªát
                    vietWordNeeds[i] = englishWord;
                }
                document.getElementById('sourceLang').textContent = 'üáªüá≥ Ti·∫øng Vi·ªát';
                document.getElementById('poolLang').textContent = 'üá¨üáß Ti·∫øng Anh r∆°i';
            } else {
                // Ch·∫ø ƒë·ªô Anh -> Vi·ªát
                for (let i = 0; i < currentStory.en.length; i++) {
                    const vietWord = currentStory.vi[i];
                    translationMap[i] = vietWord;
                    displayMap[i] = currentStory.en[i];
                    
                    englishWordCount[vietWord] = (englishWordCount[vietWord] || 0) + 1;
                    vietWordNeeds[i] = vietWord;
                }
                document.getElementById('sourceLang').textContent = 'üá¨üáß Ti·∫øng Anh';
                document.getElementById('poolLang').textContent = 'üáªüá≥ Ti·∫øng Vi·ªát r∆°i';
            }
            
            totalWords = Object.keys(translationMap).length;
            
            console.log('English counts:', englishWordCount);
            console.log('Viet needs:', vietWordNeeds);
            
            createVietnameseTiles();
            
            // T·∫°o m·∫£ng t·ª´ ti·∫øng Anh r∆°i
            remainingEnglishWords = [];
            for (let i = 0; i < totalWords; i++) {
                remainingEnglishWords.push(translationMap[i]);
            }
            remainingEnglishWords = shuffleArray(remainingEnglishWords);
            
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
            
            startTimer();
            startFallingWords();
        }
        
        function createVietnameseTiles() {
            const sourceGrid = document.getElementById('sourceGrid');
            sourceGrid.innerHTML = '';
            
            // T·∫°o tile theo th·ª© t·ª± index
            for (let i = 0; i < totalWords; i++) {
                const tile = document.createElement('div');
                tile.className = 'viet-tile';
                tile.textContent = displayMap[i];
                tile.dataset.index = i;
                tile.dataset.matched = 'false';
                
                sourceGrid.appendChild(tile);
            }
            
            document.getElementById('sourceCount').textContent = `0/${totalWords} t·ª´`;
            document.getElementById('gameProgress').textContent = `0/${totalWords} t·ª´ ƒë√£ d·ªãch`;
        }
        
        function startFallingWords() {
            fallingInterval = setInterval(() => {
                if (isPaused || !isGameActive) return;
                
                if (remainingEnglishWords.length > 0) {
                    const randomIndex = Math.floor(Math.random() * remainingEnglishWords.length);
                    const word = remainingEnglishWords[randomIndex];
                    
                    createFallingWord(word);
                    remainingEnglishWords.splice(randomIndex, 1);
                }
                
                const maxHeight = Math.max(...columnHeights);
                const isMobile = window.innerWidth <= 768;
                const warningThreshold = isMobile ? 250 : 350;
                const gameOverThreshold = isMobile ? 300 : 420;

                if (maxHeight > warningThreshold) {
                    document.getElementById('poolWarning').style.display = 'block';
                    
                    if (!easyMode && maxHeight > gameOverThreshold) {
                        endGame('lose');
                    }
                } else {
                    document.getElementById('poolWarning').style.display = 'none';
                }

                if (easyMode && maxHeight > warningThreshold) {
                    document.getElementById('poolWarning').innerHTML = '‚ö†Ô∏è Stack g·∫ßn ƒë·∫ßy! (Ch·∫ø ƒë·ªô d·ªÖ - kh√¥ng thua)';
                } else {
                    document.getElementById('poolWarning').innerHTML = '‚ö†Ô∏è S·∫Øp ƒë·∫ßy!';
                }
                
            }, 2000);
            
            startFallingAnimation();
        }
        
        function createFallingWord(word) {
            const container = document.getElementById('fallingWords');
            const column = Math.floor(Math.random() * columns);
            
            const isMobile = window.innerWidth <= 768;
            let leftPos;
            if (isMobile) {
                leftPos = [3, 35, 67][column];
            } else {
                leftPos = [10, 38, 66][column];
            }
            
            const wordTile = document.createElement('div');
            wordTile.className = 'english-tile';
            wordTile.textContent = word;
            wordTile.dataset.word = word;
            wordTile.dataset.column = column;
            wordTile.dataset.top = '0';
            wordTile.style.top = '0px';
            wordTile.style.left = leftPos + '%';
            
            container.appendChild(wordTile);
            
            activeEnglishWords.push({
                element: wordTile,
                word: word,
                column: column,
                top: 0,
                speed: 0.8 + Math.random() * 0.7,
                left: leftPos,
                isFalling: true
            });
        }
        
        function startFallingAnimation() {
            function animate() {
                if (!isGameActive) return;
                
                if (!isPaused) {
                    for (let i = activeEnglishWords.length - 1; i >= 0; i--) {
                        const item = activeEnglishWords[i];
                        
                        item.top += item.speed;
                        
                        const column = item.column;
                        
                        const isMobile = window.innerWidth <= 768;
                        let bottomLimit = isMobile ? 280 : 420;
                        
                        if (columnWords[column].length > 0) {
                            const topStackWord = columnWords[column][columnWords[column].length - 1];
                            const topStackTop = parseFloat(topStackWord.element.style.top);
                            bottomLimit = topStackTop - (isMobile ? 28 : 38);
                        } else {
                            bottomLimit = (isMobile ? 280 : 420) - (isMobile ? 28 : 38);
                        }
                        
                        if (item.top >= bottomLimit) {
                            item.top = bottomLimit;
                            item.element.style.top = item.top + 'px';
                            
                            addToStack(item, column);
                            activeEnglishWords.splice(i, 1);
                        } else {
                            item.element.style.top = item.top + 'px';
                        }
                    }
                }
                
                animationFrame = requestAnimationFrame(animate);
            }
            
            animate();
        }
        
        function addToStack(item, column) {
            const word = item.word;
            const element = item.element;
            
            const isMobile = window.innerWidth <= 768;
            const tileHeight = isMobile ? 28 : 38;
            const containerHeight = isMobile ? 280 : 420;
            
            let newTop;
            if (columnWords[column].length === 0) {
                newTop = containerHeight - tileHeight;
            } else {
                const lastWord = columnWords[column][columnWords[column].length - 1];
                const lastTop = parseFloat(lastWord.element.style.top);
                newTop = lastTop - tileHeight;
            }
            
            element.style.top = newTop + 'px';
            element.style.position = 'absolute';
            element.style.backgroundColor = '#8e44ad';
            element.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
            element.style.zIndex = '5';
            element.style.cursor = 'pointer';
            
            columnWords[column].push({
                word: word,
                element: element,
                top: newTop
            });
            
            columnHeights[column] = columnWords[column].length * tileHeight;
        }

        function removeFromStack(word, column) {
            const isMobile = window.innerWidth <= 768;
            const tileHeight = isMobile ? 28 : 38;
            const containerHeight = isMobile ? 280 : 420;
            
            // T√¨m index c·ªßa t·ª´ trong stack - ch·ªâ c·∫ßn t√¨m theo word
            const index = columnWords[column].findIndex(w => w.word === word);
            
            if (index !== -1) {
                columnWords[column].splice(index, 1);
                
                // C·∫≠p nh·∫≠t l·∫°i v·ªã tr√≠ c√°c t·ª´ c√≤n l·∫°i
                for (let i = 0; i < columnWords[column].length; i++) {
                    const item = columnWords[column][i];
                    const newTop = containerHeight - ((i + 1) * tileHeight);
                    item.element.style.top = newTop + 'px';
                    item.top = newTop;
                }
                
                columnHeights[column] = columnWords[column].length * tileHeight;
                return true;
            }
            return false;
        }

        // X·ª≠ l√Ω click tr√™n tile ti·∫øng Anh
        document.addEventListener('click', function(e) {
            const tile = e.target.closest('.english-tile');
            if (!tile) return;
            
            e.preventDefault();
            
            if (isPaused || !isGameActive) return;
            
            // B·ªè ch·ªçn tile tr∆∞·ªõc ƒë√≥
            if (selectedEnglishTile) {
                selectedEnglishTile.classList.remove('selected');
            }
            
            // Ch·ªçn tile m·ªõi
            tile.classList.add('selected');
            selectedEnglishTile = tile;
            
            console.log('Selected English:', tile.dataset.word);
        });
        
        // X·ª≠ l√Ω click tr√™n tile ti·∫øng Vi·ªát
        document.addEventListener('click', function(e) {
            const vietTile = e.target.closest('.viet-tile');
            if (!vietTile) return;
            
            e.preventDefault();
            
            if (isPaused || !isGameActive) return;
            if (vietTile.dataset.matched === 'true') return;
            
            if (!selectedEnglishTile) {
                showToast('Ch·ªçn t·ª´ ti·∫øng Anh tr∆∞·ªõc!', '#f39c12');
                return;
            }
            
            const vietIndex = parseInt(vietTile.dataset.index);
            const neededWord = vietWordNeeds[vietIndex];  // T·ª´ c·∫ßn (ƒë√°p √°n)
            const selectedWord = selectedEnglishTile.dataset.word;
            
            console.log('V·ªã tr√≠', vietIndex, 'c·∫ßn t·ª´:', neededWord);
            console.log('Ng∆∞·ªùi ch∆°i ch·ªçn:', selectedWord);
            console.log('S·ªë l∆∞·ª£ng c√≤n l·∫°i:', englishWordCount[selectedWord]);
            
            // KI·ªÇM TRA: T·ª´ ƒë∆∞·ª£c ch·ªçn c√≥ ƒë√∫ng l√† t·ª´ c·∫ßn kh√¥ng
            // V√Ä t·ª´ ƒë√≥ v·∫´n c√≤n s·ªë l∆∞·ª£ng
            if (selectedWord === neededWord && englishWordCount[selectedWord] > 0) {
                // ƒê√öNG
                processCorrectMatch(vietTile, selectedEnglishTile, vietIndex, selectedWord);
            } else {
                // SAI
                processWrongMatch(vietTile, selectedEnglishTile);
            }
        });

        function processCorrectMatch(vietTile, englishTile, vietIndex, word) {
            rightSound.play().catch(e => {});
            
            // Gi·∫£m s·ªë l∆∞·ª£ng c·ªßa t·ª´ n√†y
            englishWordCount[word]--;
            
            // ƒê√°nh d·∫•u tile ti·∫øng Vi·ªát ƒë√£ ƒë∆∞·ª£c d·ªãch
            vietTile.dataset.matched = 'true';
            vietTile.classList.add('matched');
            
            // HI·ªÇN TH·ªä T·ª™ TI·∫æNG ANH L√äN TILE
            vietTile.textContent = word;
            
            // L·∫•y v·ªã tr√≠ c·ªßa tile ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng
            const rect = vietTile.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // T·∫†O HI·ªÜU ·ª®NG THEO COMBO
            createCorrectEffect(centerX, centerY, combo);
            
            // X√≥a t·ª´ ti·∫øng Anh kh·ªèi game
            const column = parseInt(englishTile.dataset.column);
            
            // T√¨m trong active words
            const inActive = activeEnglishWords.find(w => w.element === englishTile);
            if (inActive) {
                activeEnglishWords = activeEnglishWords.filter(w => w.element !== englishTile);
            } else {
                // T√¨m trong stack
                removeFromStack(word, column);
            }
            
            englishTile.remove();
            selectedEnglishTile = null;
            
            // C·∫≠p nh·∫≠t ƒëi·ªÉm
            combo++;
            const points = 10 + ((combo - 1) * 2);
            score += points;
            
            document.getElementById('score').textContent = score;
            document.getElementById('combo').textContent = `x${combo}`;
            
            // C·∫≠p nh·∫≠t progress
            const matchedCount = document.querySelectorAll('.viet-tile.matched').length;
            document.getElementById('sourceCount').textContent = `${matchedCount}/${totalWords} t·ª´`;
            document.getElementById('gameProgress').textContent = `${matchedCount}/${totalWords} t·ª´ ƒë√£ d·ªãch`;
            
            // Ki·ªÉm tra chi·∫øn th·∫Øng
            if (matchedCount === totalWords) {
                endGame('win');
            }
        }

        function processWrongMatch(vietTile, englishTile) {
            wrongSound.play().catch(e => {});
            
            // Reset combo
            combo = 0;
            document.getElementById('combo').textContent = 'x0';
            
            // Flash ƒë·ªè c·∫£ hai tile
            vietTile.style.animation = 'shake 0.5s';
            englishTile.style.animation = 'shake 0.5s';
            setTimeout(() => {
                vietTile.style.animation = '';
                englishTile.style.animation = '';
            }, 500);
            
            // B·ªè ch·ªçn t·ª´ ti·∫øng Anh
            englishTile.classList.remove('selected');
            selectedEnglishTile = null;
        }
        
        // HINT M·ªöI: Ch·ªçn ng·∫´u nhi√™n 1 t·ª´ trong wordpool
        function useHint() {
            if (hintCount <= 0) {
                showToast('H·∫øt l∆∞·ª£t hint!', '#e74c3c');
                return;
            }
            
            if (isPaused || !isGameActive) return;
            
            // L·∫•y t·∫•t c·∫£ c√°c t·ª´ ti·∫øng Anh ƒëang c√≥ tr√™n m√†n h√¨nh (c·∫£ ƒëang r∆°i v√† trong stack)
            const availableEnglishTiles = Array.from(document.querySelectorAll('.english-tile'));
            
            if (availableEnglishTiles.length === 0) {
                showToast('Kh√¥ng c√≥ t·ª´ ti·∫øng Anh n√†o tr√™n m√†n h√¨nh!', '#f39c12');
                return;
            }
            
            // Ch·ªçn ng·∫´u nhi√™n 1 t·ª´ ti·∫øng Anh
            const randomEnglishTile = availableEnglishTiles[Math.floor(Math.random() * availableEnglishTiles.length)];
            const selectedWord = randomEnglishTile.dataset.word;
            
            // T√¨m t·∫•t c·∫£ v·ªã tr√≠ ti·∫øng Vi·ªát c·∫ßn t·ª´ n√†y (c√≤n ch∆∞a ƒë∆∞·ª£c d·ªãch)
            const neededPositions = [];
            for (let i = 0; i < totalWords; i++) {
                const vietTile = document.querySelector(`.viet-tile[data-index="${i}"]`);
                // Ki·ªÉm tra v·ªã tr√≠ n√†y c·∫ßn t·ª´ selectedWord V√Ä ch∆∞a ƒë∆∞·ª£c d·ªãch
                if (vietWordNeeds[i] === selectedWord && vietTile && vietTile.dataset.matched === 'false') {
                    neededPositions.push(i);
                }
            }
            
            if (neededPositions.length === 0) {
                // Tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát: t·ª´ n√†y ƒë√£ ƒë∆∞·ª£c d√πng h·∫øt cho c√°c v·ªã tr√≠ c·∫ßn n√≥
                showToast(`T·ª´ "${selectedWord}" ƒë√£ ƒë∆∞·ª£c d√πng h·∫øt!`, '#f39c12');
                
                // V·∫´n highlight t·ª´ ti·∫øng Anh ƒë·ªÉ ng∆∞·ªùi ch∆°i bi·∫øt
                randomEnglishTile.classList.add('highlight');
                setTimeout(() => {
                    randomEnglishTile.classList.remove('highlight');
                }, 2000);
                return;
            }
            
            // Highlight t·ª´ ti·∫øng Anh ƒë∆∞·ª£c ch·ªçn
            randomEnglishTile.classList.add('highlight');
            
            // Highlight t·∫•t c·∫£ v·ªã tr√≠ ti·∫øng Vi·ªát c·∫ßn t·ª´ n√†y
            neededPositions.forEach(index => {
                const vietTile = document.querySelector(`.viet-tile[data-index="${index}"]`);
                if (vietTile) {
                    vietTile.classList.add('highlight');
                }
            });
            
            // Th√¥ng b√°o cho ng∆∞·ªùi ch∆°i
            if (neededPositions.length === 1) {
                showToast(`T·ª´ "${selectedWord}" gh√©p v·ªõi 1 v·ªã tr√≠`, '#9b59b6');
            } else {
                showToast(`T·ª´ "${selectedWord}" c√≥ th·ªÉ gh√©p v·ªõi ${neededPositions.length} v·ªã tr√≠`, '#9b59b6');
            }
            
            // B·ªè highlight sau 3 gi√¢y
            setTimeout(() => {
                randomEnglishTile.classList.remove('highlight');
                neededPositions.forEach(index => {
                    const vietTile = document.querySelector(`.viet-tile[data-index="${index}"]`);
                    if (vietTile) {
                        vietTile.classList.remove('highlight');
                    }
                });
            }, 3000);
            
            hintCount--;
            document.getElementById('hintLeft').textContent = hintCount;
            document.getElementById('hintCount').textContent = hintCount;
        }
        
        // ========== HI·ªÜU ·ª®NG KHI D·ªäCH ƒê√öNG ==========
        function createCorrectEffect(x, y, comboLevel) {
            const effectLevel = Math.min(comboLevel, 10); // Gi·ªõi h·∫°n t·ªëi ƒëa level 10
            
            // Hi·ªáu ·ª©ng c∆° b·∫£n (lu√¥n c√≥)
            createStarEffect(x, y, 5 + effectLevel);
            createParticles(x, y, 10 + effectLevel * 2);
            
            // Hi·ªáu ·ª©ng ƒë·∫∑c bi·ªát theo streak
            if (comboLevel >= 3) {
                createFloatingEmojis(x, y, Math.floor(comboLevel / 2));
            }
            
            if (comboLevel >= 5) {
                createScreenFlash();
                createComboText(comboLevel);
            }
            
            if (comboLevel >= 8) {
                createRainbowEffect();
                createConfetti(50);
            }
            
            if (comboLevel >= 10) {
                createExplosion(x, y);
            }
        }

        // T·∫°o hi·ªáu ·ª©ng ng√¥i sao
        function createStarEffect(x, y, count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const star = document.createElement('div');
                    star.className = 'correct-effect star';
                    star.innerHTML = ['‚òÖ', '‚ú®', 'üí´'][Math.floor(Math.random() * 3)];
                    star.style.left = (x + (Math.random() - 0.5) * 200) + 'px';
                    star.style.top = (y + (Math.random() - 0.5) * 100) + 'px';
                    star.style.fontSize = (15 + Math.random() * 20) + 'px';
                    document.body.appendChild(star);
                    setTimeout(() => star.remove(), 1000);
                }, i * 50);
            }
        }

        // T·∫°o c√°c h·∫°t nh·ªè
        function createParticles(x, y, count) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'confetti-particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                particle.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                // H∆∞·ªõng bay ng·∫´u nhi√™n
                const angle = Math.random() * Math.PI * 2;
                
                // Th√™m animation ri√™ng
                particle.animate([
                    { transform: 'translate(0, 0) rotate(0deg)', opacity: 1 },
                    { transform: `translate(${Math.cos(angle) * 100}px, ${Math.sin(angle) * 100}px) rotate(720deg)`, opacity: 0 }
                ], {
                    duration: 1000 + Math.random() * 1000,
                    easing: 'ease-out'
                });
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 2000);
            }
        }

        // T·∫°o emoji bay
        function createFloatingEmojis(x, y, count) {
            const emojis = ['üéâ', 'üéä', '‚≠ê', 'üåü', 'üíØ', 'üî•', '‚ö°', 'üí•', '‚ú®', 'üí´'];
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.className = 'correct-effect emoji';
                    emoji.innerHTML = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.left = (x + (Math.random() - 0.5) * 150) + 'px';
                    emoji.style.top = y + 'px';
                    emoji.style.fontSize = (20 + Math.random() * 30) + 'px';
                    document.body.appendChild(emoji);
                    setTimeout(() => emoji.remove(), 1500);
                }, i * 100);
            }
        }

        // T·∫°o flash m√†n h√¨nh
        function createScreenFlash() {
            const flash = document.createElement('div');
            flash.className = 'screen-flash';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 300);
        }

        // T·∫°o text combo
        function createComboText(comboLevel) {
            const text = document.createElement('div');
            text.className = 'combo-text';
            text.innerHTML = `üî• COMBO x${comboLevel}! üî•`;
            document.body.appendChild(text);
            setTimeout(() => text.remove(), 1000);
        }

        // T·∫°o hi·ªáu ·ª©ng c·∫ßu v·ªìng (cho m√†n h√¨nh)
        function createRainbowEffect() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(45deg, 
                    rgba(255,0,0,0.2), 
                    rgba(255,165,0,0.2), 
                    rgba(255,255,0,0.2), 
                    rgba(0,128,0,0.2), 
                    rgba(0,0,255,0.2), 
                    rgba(75,0,130,0.2), 
                    rgba(238,130,238,0.2));
                background-size: 400% 400%;
                animation: rainbow 2s ease-out;
                pointer-events: none;
                z-index: 9996;
            `;
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), 2000);
        }

        // T·∫°o confetti kh·∫Øp m√†n h√¨nh
        function createConfetti(count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-particle';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = '-10px';
                    confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    confetti.style.width = (5 + Math.random() * 10) + 'px';
                    confetti.style.height = (5 + Math.random() * 10) + 'px';
                    
                    confetti.animate([
                        { transform: 'translate(0, 0) rotate(0deg)', opacity: 1 },
                        { transform: `translate(${(Math.random() - 0.5) * 200}px, ${window.innerHeight + 100}px) rotate(${Math.random() * 720}deg)`, opacity: 0 }
                    ], {
                        duration: 2000 + Math.random() * 2000,
                        easing: 'ease-out'
                    });
                    
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 50);
            }
        }

        // T·∫°o hi·ªáu ·ª©ng n·ªï l·ªõn (khi combo 10+)
        function createExplosion(x, y) {
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    createStarEffect(x, y, 5);
                    createParticles(x, y, 10);
                }, i * 50);
            }
        }
        
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (!isPaused && isGameActive) {
                    timeElapsed++;
                    document.getElementById('timer').textContent = timeElapsed;
                    
                    const bonus = Math.floor(timeElapsed / 30) * 5;
                    document.getElementById('bonusInfo').textContent = `+${bonus}`;
                }
            }, 1000);
        }
        
        function pauseGame() {
            isPaused = true;
            document.getElementById('pauseOverlay').style.display = 'flex';
        }
        
        function resumeGame() {
            isPaused = false;
            document.getElementById('pauseOverlay').style.display = 'none';
        }
        
        function endGame(result) {
            isGameActive = false;
            clearInterval(timerInterval);
            clearInterval(fallingInterval);
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            
            if (result === 'win') {
                winSound.play().catch(e => {});
            } else {
                wrongSound.play().catch(e => {});
            }
            
            const modal = document.getElementById('resultModal');
            const content = document.getElementById('resultContent');
            const title = document.getElementById('resultTitle');
            const stats = document.getElementById('resultStats');
            const translatedDiv = document.getElementById('translatedText');
            
            content.className = `result-content ${result}`;
            title.textContent = result === 'win' ? 'üèÜ CHI·∫æN TH·∫ÆNG!' : 'üíÄ GAME OVER';
            
            const matchedCount = document.querySelectorAll('.viet-tile.matched').length;
            const accuracy = totalWords > 0 ? Math.round((matchedCount / totalWords) * 100) : 0;
            
            // T·∫°o ƒëo·∫°n vƒÉn ƒë√£ d·ªãch
            let translatedHtml = '';
            const tiles = document.querySelectorAll('.viet-tile');
            tiles.forEach(tile => {
                const index = parseInt(tile.dataset.index);
                if (tile.dataset.matched === 'true') {
                    translatedHtml += `<span class="filled-word">${translationMap[index]}</span> `;
                } else {
                    translatedHtml += `<span class="empty-word">${displayMap[index]}</span> `;
                }
            });
            
            stats.innerHTML = `
                <div class="stat-row">
                    <span>üìö Level:</span>
                    <span>${selectedLevel}</span>
                </div>
                <div class="stat-row">
                    <span>üìñ Story:</span>
                    <span>${selectedUnit}</span>
                </div>
                <div class="stat-row">
                    <span>üåç Ch·∫ø ƒë·ªô:</span>
                    <span>${translationMode === 'vi-en' ? 'Vi·ªát ‚Üí Anh' : 'Anh ‚Üí Vi·ªát'}</span>
                </div>
                <div class="stat-row">
                    <span>üåü Ch·∫ø ƒë·ªô d·ªÖ:</span>
                    <span>${easyMode ? 'B·∫¨T' : 'T·∫ÆT'}</span>
                </div>
                <div class="stat-row">
                    <span>‚è±Ô∏è Th·ªùi gian:</span>
                    <span>${timeElapsed} gi√¢y</span>
                </div>
                <div class="stat-row">
                    <span>‚ú® ƒêi·ªÉm s·ªë:</span>
                    <span>${score}</span>
                </div>
                <div class="stat-row">
                    <span>üî• Combo cao nh·∫•t:</span>
                    <span>x${combo}</span>
                </div>
                <div class="stat-row">
                    <span>üìä ƒê·ªô ch√≠nh x√°c:</span>
                    <span>${matchedCount}/${totalWords} t·ª´ (${accuracy}%)</span>
                </div>
            `;
            
            translatedDiv.innerHTML = translatedHtml || 'Ch∆∞a c√≥ t·ª´ n√†o ƒë∆∞·ª£c d·ªãch';
            
            modal.style.display = 'flex';
        }
        
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        function playAgain() {
            location.reload();
        }
        
        function backToMenu() {
            document.getElementById('resultModal').style.display = 'none';
            document.getElementById('gameSection').style.display = 'none';
            document.getElementById('setupSection').style.display = 'block';
        }

        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                document.body.style.display = 'none';
                document.body.offsetHeight;
                document.body.style.display = 'flex';
            }, 100);
        });
    </script>
</body>
</html>
